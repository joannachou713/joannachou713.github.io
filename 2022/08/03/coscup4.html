<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Deploy Rails with Docker Swarm (4) - Gitlab Runner 自動化部署 | Jacquelyn’s Blog</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Deploy Rails with Docker Swarm (4) - Gitlab Runner 自動化部署" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="自動化部署 with Gitlab Runner Registration 進入上一篇開好的 Manager EC2，並且此時的 EC2 應該已經安裝好 Gitlab Runner，這時候可以直接註冊我們的 Runner：sudo gitlab-runner register，下好指令後一共會問七個問題： Gitlab instance URL Registration Code 前兩個問題可以進入到 Gitlab project &gt; Settings &gt; CI/CD &gt; Runner 去查看設定細節，如附圖的左側 Description for runner: docker 附圖右側白底黑字的部分 Tags for runner(comma seperated): prod 附圖藍底部分，且這個 tag 是在後續指定 job 要哪個 runner 執行的依據 Optional maintenance note for runner: (optional) Enter the executor: docker Default Docker image: tiangolo/docker-with-compose 後續的 job 需要 compose 幫我們 build image，因此需要指定這個 image .gitlab-ci.yml 這邊主要也是參考 dockerswarm.rocks 的範例，以下簡單介紹一下他的設定內容： Stage: 分為 build 與 deploy Build: docker-compose build --build-arg RAILS_MASTER_KEY=$RAILS_MASTER_KEY 單純只有 build image，但因為我的 Dockerfile 包含了 Asset Precompile，因此需要帶入 RAILS_MASTER_KEY 做為參數 Deploy: docker stack deploy -c docker-compose.yml [stack name] Only: 指定發生於 main branch Tags: 用於指定執行的 runner EC2 Prerequisites 因為 Traefik 與 Rails App 為獨立的兩個 Stack，為了簡化開發流程，這邊選擇手動進入 EC2 部署 Traefik 原本是另外開一個 traefik 分支做 Traefik 部署（並且指定 Traefik 部署的 job 只發生在該分支、只會發生一次），但在演講時有人反映不確定 traefik 分支部署後要不要合到 main 分支上、git graph 有點不明確，因此改為以公司實際部署的流程做介紹 部署的步驟就像在實際部署流程提到的圖表一樣： 開啟一個 swarm：docker swarm init --default-addr-pool 10.20.0.0/16 因為 Docker 預設的 subnet range 與 EC2 相同，都是 10.0.0.1，因此這邊要特別指定不一樣的範圍， Swarm 才連的到外網 開啟 traefik network：docker network create --driver=overlay traefik-public 取得現在的 swarm manager node id：export NODE_ID=$(docker info -f &#39;&#39;) 指定 traefik 每次都 deploy 在同一個 node &amp; volume 上：docker node update --label-add traefik-public.traefik-public-certificates=true $NODE_ID 部署 traefik：docker stack deploy -c traefik.yml traefik 最後就是把 App 推上 GitLab 進行部署ㄌ！！！ Worker Node 加入 Docker Swarm 到這邊設定完 Manager 節點後，我們可以回去開 Worker Template，把加入 Swarm 的指令加回去： 先在 Manager 找回加入 Swarm 的指令：docker swarm join-token worker 在 Worker Template 的 User Data 中加入剛剛找回的指令，於是最終的 User Data 會長下面這樣： #!/bin/bash # Start docker daemon sudo service docker start sudo chown ec2-user:docker /var/run/docker.sock # Join swarm docker swarm join --token [JOIN-TOKEN] [IP-ADDRESS]:2377 到這邊主要的技術設定都結束了…..真的是超多內容要介紹：） 下一篇會補充一些相關的議題討論，還有這次 COSCUP 演講的心得，希望我不要隔太久才把文章生出來：）" />
<meta property="og:description" content="自動化部署 with Gitlab Runner Registration 進入上一篇開好的 Manager EC2，並且此時的 EC2 應該已經安裝好 Gitlab Runner，這時候可以直接註冊我們的 Runner：sudo gitlab-runner register，下好指令後一共會問七個問題： Gitlab instance URL Registration Code 前兩個問題可以進入到 Gitlab project &gt; Settings &gt; CI/CD &gt; Runner 去查看設定細節，如附圖的左側 Description for runner: docker 附圖右側白底黑字的部分 Tags for runner(comma seperated): prod 附圖藍底部分，且這個 tag 是在後續指定 job 要哪個 runner 執行的依據 Optional maintenance note for runner: (optional) Enter the executor: docker Default Docker image: tiangolo/docker-with-compose 後續的 job 需要 compose 幫我們 build image，因此需要指定這個 image .gitlab-ci.yml 這邊主要也是參考 dockerswarm.rocks 的範例，以下簡單介紹一下他的設定內容： Stage: 分為 build 與 deploy Build: docker-compose build --build-arg RAILS_MASTER_KEY=$RAILS_MASTER_KEY 單純只有 build image，但因為我的 Dockerfile 包含了 Asset Precompile，因此需要帶入 RAILS_MASTER_KEY 做為參數 Deploy: docker stack deploy -c docker-compose.yml [stack name] Only: 指定發生於 main branch Tags: 用於指定執行的 runner EC2 Prerequisites 因為 Traefik 與 Rails App 為獨立的兩個 Stack，為了簡化開發流程，這邊選擇手動進入 EC2 部署 Traefik 原本是另外開一個 traefik 分支做 Traefik 部署（並且指定 Traefik 部署的 job 只發生在該分支、只會發生一次），但在演講時有人反映不確定 traefik 分支部署後要不要合到 main 分支上、git graph 有點不明確，因此改為以公司實際部署的流程做介紹 部署的步驟就像在實際部署流程提到的圖表一樣： 開啟一個 swarm：docker swarm init --default-addr-pool 10.20.0.0/16 因為 Docker 預設的 subnet range 與 EC2 相同，都是 10.0.0.1，因此這邊要特別指定不一樣的範圍， Swarm 才連的到外網 開啟 traefik network：docker network create --driver=overlay traefik-public 取得現在的 swarm manager node id：export NODE_ID=$(docker info -f &#39;&#39;) 指定 traefik 每次都 deploy 在同一個 node &amp; volume 上：docker node update --label-add traefik-public.traefik-public-certificates=true $NODE_ID 部署 traefik：docker stack deploy -c traefik.yml traefik 最後就是把 App 推上 GitLab 進行部署ㄌ！！！ Worker Node 加入 Docker Swarm 到這邊設定完 Manager 節點後，我們可以回去開 Worker Template，把加入 Swarm 的指令加回去： 先在 Manager 找回加入 Swarm 的指令：docker swarm join-token worker 在 Worker Template 的 User Data 中加入剛剛找回的指令，於是最終的 User Data 會長下面這樣： #!/bin/bash # Start docker daemon sudo service docker start sudo chown ec2-user:docker /var/run/docker.sock # Join swarm docker swarm join --token [JOIN-TOKEN] [IP-ADDRESS]:2377 到這邊主要的技術設定都結束了…..真的是超多內容要介紹：） 下一篇會補充一些相關的議題討論，還有這次 COSCUP 演講的心得，希望我不要隔太久才把文章生出來：）" />
<link rel="canonical" href="https://jqlynchien713.github.io/2022/08/03/coscup4.html" />
<meta property="og:url" content="https://jqlynchien713.github.io/2022/08/03/coscup4.html" />
<meta property="og:site_name" content="Jacquelyn’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-08-03T15:16:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Deploy Rails with Docker Swarm (4) - Gitlab Runner 自動化部署" />
<script type="application/ld+json">
{"description":"自動化部署 with Gitlab Runner Registration 進入上一篇開好的 Manager EC2，並且此時的 EC2 應該已經安裝好 Gitlab Runner，這時候可以直接註冊我們的 Runner：sudo gitlab-runner register，下好指令後一共會問七個問題： Gitlab instance URL Registration Code 前兩個問題可以進入到 Gitlab project &gt; Settings &gt; CI/CD &gt; Runner 去查看設定細節，如附圖的左側 Description for runner: docker 附圖右側白底黑字的部分 Tags for runner(comma seperated): prod 附圖藍底部分，且這個 tag 是在後續指定 job 要哪個 runner 執行的依據 Optional maintenance note for runner: (optional) Enter the executor: docker Default Docker image: tiangolo/docker-with-compose 後續的 job 需要 compose 幫我們 build image，因此需要指定這個 image .gitlab-ci.yml 這邊主要也是參考 dockerswarm.rocks 的範例，以下簡單介紹一下他的設定內容： Stage: 分為 build 與 deploy Build: docker-compose build --build-arg RAILS_MASTER_KEY=$RAILS_MASTER_KEY 單純只有 build image，但因為我的 Dockerfile 包含了 Asset Precompile，因此需要帶入 RAILS_MASTER_KEY 做為參數 Deploy: docker stack deploy -c docker-compose.yml [stack name] Only: 指定發生於 main branch Tags: 用於指定執行的 runner EC2 Prerequisites 因為 Traefik 與 Rails App 為獨立的兩個 Stack，為了簡化開發流程，這邊選擇手動進入 EC2 部署 Traefik 原本是另外開一個 traefik 分支做 Traefik 部署（並且指定 Traefik 部署的 job 只發生在該分支、只會發生一次），但在演講時有人反映不確定 traefik 分支部署後要不要合到 main 分支上、git graph 有點不明確，因此改為以公司實際部署的流程做介紹 部署的步驟就像在實際部署流程提到的圖表一樣： 開啟一個 swarm：docker swarm init --default-addr-pool 10.20.0.0/16 因為 Docker 預設的 subnet range 與 EC2 相同，都是 10.0.0.1，因此這邊要特別指定不一樣的範圍， Swarm 才連的到外網 開啟 traefik network：docker network create --driver=overlay traefik-public 取得現在的 swarm manager node id：export NODE_ID=$(docker info -f &#39;&#39;) 指定 traefik 每次都 deploy 在同一個 node &amp; volume 上：docker node update --label-add traefik-public.traefik-public-certificates=true $NODE_ID 部署 traefik：docker stack deploy -c traefik.yml traefik 最後就是把 App 推上 GitLab 進行部署ㄌ！！！ Worker Node 加入 Docker Swarm 到這邊設定完 Manager 節點後，我們可以回去開 Worker Template，把加入 Swarm 的指令加回去： 先在 Manager 找回加入 Swarm 的指令：docker swarm join-token worker 在 Worker Template 的 User Data 中加入剛剛找回的指令，於是最終的 User Data 會長下面這樣： #!/bin/bash # Start docker daemon sudo service docker start sudo chown ec2-user:docker /var/run/docker.sock # Join swarm docker swarm join --token [JOIN-TOKEN] [IP-ADDRESS]:2377 到這邊主要的技術設定都結束了…..真的是超多內容要介紹：） 下一篇會補充一些相關的議題討論，還有這次 COSCUP 演講的心得，希望我不要隔太久才把文章生出來：）","url":"https://jqlynchien713.github.io/2022/08/03/coscup4.html","headline":"Deploy Rails with Docker Swarm (4) - Gitlab Runner 自動化部署","@type":"BlogPosting","dateModified":"2022-08-03T15:16:00+00:00","datePublished":"2022-08-03T15:16:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://jqlynchien713.github.io/2022/08/03/coscup4.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
  <link rel="shortcut icon" type="image/png" href="/favicon.png"><link type="application/atom+xml" rel="alternate" href="https://jqlynchien713.github.io/feed.xml" title="Jacquelyn's Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Jacquelyn&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/tags/">Tags</a><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <!-- enable latex -->
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Deploy Rails with Docker Swarm (4) - Gitlab Runner 自動化部署</h1>
    <p class="post-meta">
    <time class="dt-published" datetime="2022-08-03T15:16:00+00:00" itemprop="datePublished">Aug 3, 2022
      | 👀
      <span class="reading-time" title="Estimated read time">
        
        
                                 8 mins
                                 
      </span>
    </time>
    |
    
      <span class="tag">update</span>
    
      <span class="tag">COSCUP</span>
    
      <span class="tag">docker-swarm</span>
    
      <span class="tag">traefik</span>
    
      <span class="tag">deploy</span>
    </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="sidebar"><ul><li><a href="#自動化部署-with-gitlab-runner">自動化部署 with Gitlab Runner</a><ul><li><a href="#registration">Registration</a></li><li><a href="#gitlab-ciyml">.gitlab-ci.yml</a></li><li><a href="#ec2-prerequisites">EC2 Prerequisites</a></li></ul></li><li><a href="#最後就是把-app-推上-gitlab-進行部署ㄌ">最後就是把 App 推上 GitLab 進行部署ㄌ！！！</a><ul><li><a href="#worker-node-加入-docker-swarm">Worker Node 加入 Docker Swarm</a></li></ul></li></ul></div>
    <h2 id="自動化部署-with-gitlab-runner">自動化部署 with Gitlab Runner</h2>

<h3 id="registration">Registration</h3>

<p>進入上一篇開好的 Manager EC2，並且此時的 EC2 應該已經安裝好 Gitlab Runner，這時候可以直接註冊我們的 Runner：<code class="language-plaintext highlighter-rouge">sudo gitlab-runner register</code>，下好指令後一共會問七個問題：</p>

<ul>
  <li>Gitlab instance URL</li>
  <li>Registration Code
    <ul>
      <li>前兩個問題可以進入到 Gitlab project &gt; Settings &gt; CI/CD &gt; Runner 去查看設定細節，如附圖的左側</li>
    </ul>
  </li>
  <li>Description for runner: docker
    <ul>
      <li>附圖右側白底黑字的部分</li>
    </ul>
  </li>
  <li>Tags for runner(comma seperated): prod
    <ul>
      <li>附圖藍底部分，且這個 tag 是在<strong>後續指定 job 要哪個 runner 執行的依據</strong></li>
    </ul>
  </li>
  <li>Optional maintenance note for runner: (optional)</li>
  <li>Enter the executor: docker</li>
  <li>Default Docker image: <code class="language-plaintext highlighter-rouge">tiangolo/docker-with-compose</code>
    <ul>
      <li>後續的 job 需要 compose 幫我們 build image，因此需要指定這個 image</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/img/runner.jpg" alt="/assets/img/runner.jpg" /></p>

<h3 id="gitlab-ciyml">.gitlab-ci.yml</h3>

<p>這邊主要也是參考 <a href="https://dockerswarm.rocks/gitlab-ci/">dockerswarm.rocks</a> 的範例，以下簡單介紹一下他的設定內容：</p>

<ul>
  <li>Stage: 分為 build 與 deploy
    <ul>
      <li>Build: <code class="language-plaintext highlighter-rouge">docker-compose build --build-arg RAILS_MASTER_KEY=$RAILS_MASTER_KEY</code>
  單純只有 build image，但因為我的 Dockerfile 包含了 Asset Precompile，因此需要帶入 <code class="language-plaintext highlighter-rouge">RAILS_MASTER_KEY</code> 做為參數</li>
      <li>Deploy: <code class="language-plaintext highlighter-rouge">docker stack deploy -c docker-compose.yml [stack name]</code></li>
    </ul>
  </li>
  <li>Only: 指定發生於 main branch</li>
  <li>Tags: 用於指定執行的 runner</li>
</ul>

<h3 id="ec2-prerequisites">EC2 Prerequisites</h3>

<p>因為 Traefik 與 Rails App 為獨立的兩個 Stack，為了簡化開發流程，這邊選擇手動進入 EC2 部署 Traefik</p>

<blockquote>
  <p>原本是另外開一個 traefik 分支做 Traefik 部署（並且指定 Traefik 部署的 job 只發生在該分支、只會發生一次），但在演講時有人反映不確定 traefik 分支部署後要不要合到 main 分支上、git graph 有點不明確，因此改為以公司實際部署的流程做介紹</p>

</blockquote>

<p>部署的步驟就像在實際部署流程提到的圖表一樣：</p>

<ol>
  <li>開啟一個 swarm：<code class="language-plaintext highlighter-rouge">docker swarm init --default-addr-pool 10.20.0.0/16</code>
    <ul>
      <li>因為 Docker 預設的 subnet range 與 EC2 相同，都是 <code class="language-plaintext highlighter-rouge">10.0.0.1</code>，因此這邊要特別指定不一樣的範圍， Swarm 才連的到外網</li>
    </ul>
  </li>
  <li>開啟 traefik network：<code class="language-plaintext highlighter-rouge">docker network create --driver=overlay traefik-public</code></li>
  <li>取得現在的 swarm manager node id：<code class="language-plaintext highlighter-rouge">export NODE_ID=$(docker info -f '')</code></li>
  <li>指定 traefik 每次都 deploy 在同一個 node &amp; volume 上：<code class="language-plaintext highlighter-rouge">docker node update --label-add traefik-public.traefik-public-certificates=true $NODE_ID</code></li>
  <li>部署 traefik：<code class="language-plaintext highlighter-rouge">docker stack deploy -c traefik.yml traefik</code></li>
</ol>

<h2 id="最後就是把-app-推上-gitlab-進行部署ㄌ">最後就是把 App 推上 GitLab 進行部署ㄌ！！！</h2>

<h3 id="worker-node-加入-docker-swarm">Worker Node 加入 Docker Swarm</h3>

<p>到這邊設定完 Manager 節點後，我們可以回去開 Worker Template，把加入 Swarm 的指令加回去：</p>

<ol>
  <li>先在 Manager 找回加入 Swarm 的指令：<code class="language-plaintext highlighter-rouge">docker swarm join-token worker</code></li>
  <li>
    <p>在 Worker Template 的 User Data 中加入剛剛找回的指令，於是最終的 User Data 會長下面這樣：</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c">#!/bin/bash</span>
 <span class="c"># Start docker daemon</span>
 <span class="nb">sudo </span>service docker start
 <span class="nb">sudo chown </span>ec2-user:docker /var/run/docker.sock

 <span class="c"># Join swarm</span>
 docker swarm <span class="nb">join</span> <span class="nt">--token</span> <span class="o">[</span>JOIN-TOKEN] <span class="o">[</span>IP-ADDRESS]:2377
</code></pre></div>    </div>
  </li>
</ol>

<hr />

<p>到這邊主要的技術設定都結束了…..真的是超多內容要介紹：）</p>

<p>下一篇會補充一些相關的議題討論，還有這次 COSCUP 演講的心得，希望我不要隔太久才把文章生出來：）</p>

  </div>

  
  
    <script src="https://utteranc.es/client.js"
            repo=jqlynchien713/jqlynchien713.github.io
            issue-term=pathname
            label=Comments
            theme=github-light
            crossorigin= "anonymous"
            async>
    </script>
  

<a class="u-url" href="/2022/08/03/coscup4.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Jacquelyn&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Jacquelyn&#39;s Blog</li><li><a class="u-email" href="mailto:jqlynchien713@gmail.com">jqlynchien713@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-3"><ul class="social-media-list"><li><a href="https://github.com/jqlynchien713"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jqlynchien713</span></a></li></ul>
</div>

      <div class="footer-col footer-col-2">
        <p>ʕ •ᴥ•ʔ</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
