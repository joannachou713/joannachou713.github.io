<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Deploy Rails with Docker Swarm (3) - 實際部署流程：AWS | Jacquelyn’s Blog</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Deploy Rails with Docker Swarm (3) - 實際部署流程：AWS" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="AWS Config 這個部分在 COSCUP 的演講提到的內容很少，主要是因為時間的關係，不過我覺得這部分的設定也蠻重要的，所以會在這邊全部列出來！ AMI &amp; Template 比較 為了簡化開 EC2 的程序，我這邊會用到 AMI 與 Template 這兩個服務，先稍微比較一下他們的定義： AMI (software only)：映像檔服務，保留 EC2 上的所有安裝套件 Template (hardware only)：EC2 模板，保留一樣的 EC2 啟動精靈（包含硬體設定與 User data） 架構簡介 根據上一篇介紹的 Swarm 架構，我們會有兩種節點，分別需要的套件與設定對應如下： Node Type Manager Worker 1. AMI Docker, Gitlab Runner Docker 2. Template Start Docker EngineSpecify Security GroupSSM &amp; Route53 IAM role Start Docker EngineSpecify Security Group Manager node：需要安裝 Gitlab Runner 讓我們自動化操控這些節點，並且需要多給予 SSM &amp; Route53 權限，分別讓我們可以進入 EC2 下指令、與操作 DNS 相關的設定 Security Group：指定 worker &amp; manager 使用同個 SG，並且在這個 SG 裡開啟「所有 port 允許任何來自此 SG 的 inboud」，不過這邊開啟所有 port 的權限只是為了方便所設定，實際上還是只能指定 Docker Swarm 裡溝通用的那幾個 port，可以參考官方文件上的說明。除了這個規則以外，記得要開放 http &amp; https 的 port！ EC2 Settings 了解節點需求差異後，我在實作上的操作步驟如下： 開啟一個 EC2，安裝 docker 製作 worker AMI 回到原有的 EC2，安裝 Gitlab Runner 製作 manager AMI 開啟 AWS EC2 Template，新增一個以 worker AMI 為基礎的 template 設定 Security Group，如圖中的第一列，來源為該 SG 的 ID： 在 User Data 加上要自動執行的指令： #!/bin/bash # Start docker daemon sudo service docker start sudo chown ec2-user:docker /var/run/docker.sock 開啟 AWS EC2 Template，新增一個以 worker AMI 為基礎的 template 給予具有 SSM &amp; Route53 權限的 IAM role 設定 Security Group（同 worker template） 在 User Data 加上自動開啟 docker daemon（同 worker template） Route53 Settings 這時候可以從 Manager Template 開啟一個 EC2，去到 Route53 中的托管區域（Hosted Zone），把這個 EC2 的 public IP addr 設定 A record" />
<meta property="og:description" content="AWS Config 這個部分在 COSCUP 的演講提到的內容很少，主要是因為時間的關係，不過我覺得這部分的設定也蠻重要的，所以會在這邊全部列出來！ AMI &amp; Template 比較 為了簡化開 EC2 的程序，我這邊會用到 AMI 與 Template 這兩個服務，先稍微比較一下他們的定義： AMI (software only)：映像檔服務，保留 EC2 上的所有安裝套件 Template (hardware only)：EC2 模板，保留一樣的 EC2 啟動精靈（包含硬體設定與 User data） 架構簡介 根據上一篇介紹的 Swarm 架構，我們會有兩種節點，分別需要的套件與設定對應如下： Node Type Manager Worker 1. AMI Docker, Gitlab Runner Docker 2. Template Start Docker EngineSpecify Security GroupSSM &amp; Route53 IAM role Start Docker EngineSpecify Security Group Manager node：需要安裝 Gitlab Runner 讓我們自動化操控這些節點，並且需要多給予 SSM &amp; Route53 權限，分別讓我們可以進入 EC2 下指令、與操作 DNS 相關的設定 Security Group：指定 worker &amp; manager 使用同個 SG，並且在這個 SG 裡開啟「所有 port 允許任何來自此 SG 的 inboud」，不過這邊開啟所有 port 的權限只是為了方便所設定，實際上還是只能指定 Docker Swarm 裡溝通用的那幾個 port，可以參考官方文件上的說明。除了這個規則以外，記得要開放 http &amp; https 的 port！ EC2 Settings 了解節點需求差異後，我在實作上的操作步驟如下： 開啟一個 EC2，安裝 docker 製作 worker AMI 回到原有的 EC2，安裝 Gitlab Runner 製作 manager AMI 開啟 AWS EC2 Template，新增一個以 worker AMI 為基礎的 template 設定 Security Group，如圖中的第一列，來源為該 SG 的 ID： 在 User Data 加上要自動執行的指令： #!/bin/bash # Start docker daemon sudo service docker start sudo chown ec2-user:docker /var/run/docker.sock 開啟 AWS EC2 Template，新增一個以 worker AMI 為基礎的 template 給予具有 SSM &amp; Route53 權限的 IAM role 設定 Security Group（同 worker template） 在 User Data 加上自動開啟 docker daemon（同 worker template） Route53 Settings 這時候可以從 Manager Template 開啟一個 EC2，去到 Route53 中的托管區域（Hosted Zone），把這個 EC2 的 public IP addr 設定 A record" />
<link rel="canonical" href="https://jqlynchien713.github.io/2022/08/03/coscup3.html" />
<meta property="og:url" content="https://jqlynchien713.github.io/2022/08/03/coscup3.html" />
<meta property="og:site_name" content="Jacquelyn’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-08-03T15:13:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Deploy Rails with Docker Swarm (3) - 實際部署流程：AWS" />
<script type="application/ld+json">
{"description":"AWS Config 這個部分在 COSCUP 的演講提到的內容很少，主要是因為時間的關係，不過我覺得這部分的設定也蠻重要的，所以會在這邊全部列出來！ AMI &amp; Template 比較 為了簡化開 EC2 的程序，我這邊會用到 AMI 與 Template 這兩個服務，先稍微比較一下他們的定義： AMI (software only)：映像檔服務，保留 EC2 上的所有安裝套件 Template (hardware only)：EC2 模板，保留一樣的 EC2 啟動精靈（包含硬體設定與 User data） 架構簡介 根據上一篇介紹的 Swarm 架構，我們會有兩種節點，分別需要的套件與設定對應如下： Node Type Manager Worker 1. AMI Docker, Gitlab Runner Docker 2. Template Start Docker EngineSpecify Security GroupSSM &amp; Route53 IAM role Start Docker EngineSpecify Security Group Manager node：需要安裝 Gitlab Runner 讓我們自動化操控這些節點，並且需要多給予 SSM &amp; Route53 權限，分別讓我們可以進入 EC2 下指令、與操作 DNS 相關的設定 Security Group：指定 worker &amp; manager 使用同個 SG，並且在這個 SG 裡開啟「所有 port 允許任何來自此 SG 的 inboud」，不過這邊開啟所有 port 的權限只是為了方便所設定，實際上還是只能指定 Docker Swarm 裡溝通用的那幾個 port，可以參考官方文件上的說明。除了這個規則以外，記得要開放 http &amp; https 的 port！ EC2 Settings 了解節點需求差異後，我在實作上的操作步驟如下： 開啟一個 EC2，安裝 docker 製作 worker AMI 回到原有的 EC2，安裝 Gitlab Runner 製作 manager AMI 開啟 AWS EC2 Template，新增一個以 worker AMI 為基礎的 template 設定 Security Group，如圖中的第一列，來源為該 SG 的 ID： 在 User Data 加上要自動執行的指令： #!/bin/bash # Start docker daemon sudo service docker start sudo chown ec2-user:docker /var/run/docker.sock 開啟 AWS EC2 Template，新增一個以 worker AMI 為基礎的 template 給予具有 SSM &amp; Route53 權限的 IAM role 設定 Security Group（同 worker template） 在 User Data 加上自動開啟 docker daemon（同 worker template） Route53 Settings 這時候可以從 Manager Template 開啟一個 EC2，去到 Route53 中的托管區域（Hosted Zone），把這個 EC2 的 public IP addr 設定 A record","url":"https://jqlynchien713.github.io/2022/08/03/coscup3.html","headline":"Deploy Rails with Docker Swarm (3) - 實際部署流程：AWS","@type":"BlogPosting","dateModified":"2022-08-03T15:13:00+00:00","datePublished":"2022-08-03T15:13:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://jqlynchien713.github.io/2022/08/03/coscup3.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
  <link rel="shortcut icon" type="image/png" href="/favicon.png"><link type="application/atom+xml" rel="alternate" href="https://jqlynchien713.github.io/feed.xml" title="Jacquelyn's Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Jacquelyn&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/tags/">Tags</a><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <!-- enable latex -->
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Deploy Rails with Docker Swarm (3) - 實際部署流程：AWS</h1>
    <p class="post-meta">
    <time class="dt-published" datetime="2022-08-03T15:13:00+00:00" itemprop="datePublished">Aug 3, 2022
      | 👀
      <span class="reading-time" title="Estimated read time">
        
        
                                 6 mins
                                 
      </span>
    </time>
    |
    
      <span class="tag">update</span>
    
      <span class="tag">COSCUP</span>
    
      <span class="tag">docker-swarm</span>
    
      <span class="tag">traefik</span>
    
      <span class="tag">deploy</span>
    </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="sidebar"><ul><li><a href="#aws-config">AWS Config</a><ul><li><a href="#ami--template-比較">AMI &amp; Template 比較</a></li><li><a href="#架構簡介">架構簡介</a></li><li><a href="#ec2-settings">EC2 Settings</a></li><li><a href="#route53-settings">Route53 Settings</a></li></ul></li></ul></div>
    <h2 id="aws-config">AWS Config</h2>

<p>這個部分在 COSCUP 的演講提到的內容很少，主要是因為時間的關係，不過我覺得這部分的設定也蠻重要的，所以會在這邊全部列出來！</p>

<h3 id="ami--template-比較">AMI &amp; Template 比較</h3>

<p>為了簡化開 EC2 的程序，我這邊會用到 AMI 與 Template 這兩個服務，先稍微比較一下他們的定義：</p>

<ul>
  <li>AMI (software only)：映像檔服務，保留 EC2 上的所有安裝套件</li>
  <li>Template (hardware only)：EC2 模板，保留一樣的 EC2 啟動精靈（包含硬體設定與 User data）</li>
</ul>

<h3 id="架構簡介">架構簡介</h3>

<p>根據上一篇介紹的 Swarm 架構，我們會有兩種節點，分別需要的套件與設定對應如下：</p>

<table>
  <thead>
    <tr>
      <th>Node Type</th>
      <th>Manager</th>
      <th>Worker</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1. AMI</td>
      <td>Docker, Gitlab Runner</td>
      <td>Docker</td>
    </tr>
    <tr>
      <td>2. Template</td>
      <td>Start Docker Engine<br />Specify Security Group<br />SSM &amp; Route53 IAM role</td>
      <td>Start Docker Engine<br />Specify Security Group</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>Manager node：需要安裝 Gitlab Runner 讓我們自動化操控這些節點，並且需要多給予 SSM &amp; Route53 權限，分別讓我們可以進入 EC2 下指令、與操作 DNS 相關的設定</li>
  <li>Security Group：指定 worker &amp; manager 使用同個 SG，並且在這個 SG 裡開啟「所有 port 允許任何來自此 SG 的 inboud」，不過這邊開啟所有 port 的權限只是為了方便所設定，實際上還是只能指定 Docker Swarm 裡溝通用的那幾個 port，可以參考<a href="https://docs.docker.com/engine/swarm/swarm-tutorial/#open-protocols-and-ports-between-the-hosts:~:text=%3A%20192.168.99.100.-,Open%20protocols%20and%20ports%20between%20the%20hosts,-%F0%9F%94%97">官方文件</a>上的說明。除了這個規則以外，記得要開放 http &amp; https 的 port！</li>
</ul>

<h3 id="ec2-settings">EC2 Settings</h3>

<p>了解節點需求差異後，我在實作上的操作步驟如下：</p>

<ol>
  <li>開啟一個 EC2，安裝 docker</li>
  <li>製作 worker AMI</li>
  <li>回到原有的 EC2，安裝 Gitlab Runner</li>
  <li>製作 manager AMI</li>
  <li>開啟 AWS EC2 Template，新增一個以 worker AMI 為基礎的 template
    <ol>
      <li>
        <p>設定 Security Group，如圖中的第一列，來源為該 SG 的 ID：</p>

        <p><img src="/assets/img/sg.png" alt="/assets/img/sg.png" /></p>
      </li>
      <li>
        <p>在 User Data 加上要自動執行的指令：</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c">#!/bin/bash</span>
 <span class="c"># Start docker daemon</span>
 <span class="nb">sudo </span>service docker start
 <span class="nb">sudo chown </span>ec2-user:docker /var/run/docker.sock
</code></pre></div>        </div>
      </li>
    </ol>
  </li>
  <li>開啟 AWS EC2 Template，新增一個以 worker AMI 為基礎的 template
    <ol>
      <li>給予具有 SSM &amp; Route53 權限的 IAM role</li>
      <li>設定 Security Group（同 worker template）</li>
      <li>在 User Data 加上自動開啟 docker daemon（同 worker template）</li>
    </ol>
  </li>
</ol>

<h3 id="route53-settings">Route53 Settings</h3>

<p>這時候可以從 Manager Template 開啟一個 EC2，去到 Route53 中的托管區域（Hosted Zone），把這個 EC2 的 public IP addr 設定 A record</p>

<p><img src="/assets/img/route53.png" alt="/assets/img/route53.png" /></p>

  </div>

  
  
    <script src="https://utteranc.es/client.js"
            repo=jqlynchien713/jqlynchien713.github.io
            issue-term=pathname
            label=Comments
            theme=github-light
            crossorigin= "anonymous"
            async>
    </script>
  

<a class="u-url" href="/2022/08/03/coscup3.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Jacquelyn&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Jacquelyn&#39;s Blog</li><li><a class="u-email" href="mailto:jqlynchien713@gmail.com">jqlynchien713@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-3"><ul class="social-media-list"><li><a href="https://github.com/jqlynchien713"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jqlynchien713</span></a></li></ul>
</div>

      <div class="footer-col footer-col-2">
        <p>ʕ •ᴥ•ʔ</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
